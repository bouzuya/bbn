#!/usr/bin/env node

var Fs = require('fs');
var Path = require('path');
var Commander = require('commander-b');
var Moment = require('moment');

var program = Commander('bbn').version(require('../package.json').version);
// new command
program
.command('new', 'create a new post')
.option('-d, --date <date>')
.action(function(options) {
  options = options || {};

  var config = {};
  var configFile = Path.join(process.env.HOME, '.bbn.json');
  if (Fs.existsSync(configFile)) {
    config = require(configFile);
  }
  options.directory = config.directory || '/home/bouzuya/blog.bouzuya.net';

  var timeString = options.date ? options.date + 'T23:59:59+09:00' : null;
  var m = timeString ? Moment(timeString, 'YYYY-MM-DDThh:mm:ssZ') : Moment();
  var time = m.format();
  var date = m.format('YYYY-MM-DD');
  var template = [
    '---',
    'layout: post',
    'pubdate: "' + time + '"',
    'title: ',
    'tags: []',
    'minutes: ',
    'pagetype: posts',
    '---',
    ''
  ].join('\n');
  var directory = options.directory;
  var file = date + '-diary.markdown';
  var path = Path.join(directory, 'src/_posts', file);
  Fs.writeFileSync(path, template, { encoding: 'utf8' });
  console.log('create a new post ' + file);
});
program.execute();
